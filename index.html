<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="12.0">
    <meta name="theme-color" content="#4a90e2">
    <meta name="description" content="Ứng dụng quản lý gia phả cá nhân với bảo mật cao, hoạt động offline">
    <link rel="manifest" href="manifest.json">
    <title>Gia phả cá nhân</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
    <div class="title">
        <h1 data-i18n="title">Gia phả cá nhân</h1>
        <span id="version" class="version"></span>
    </div>
    <div class="header-controls">
        <button id="themeToggle" class="icon-btn" title="Toggle theme">
            <i class="bi bi-moon-fill"></i>
        </button>
        <button id="keyboardShortcutsBtn" class="icon-btn" title="Keyboard shortcuts">
            <i class="bi bi-keyboard"></i>
        </button>
        <select id="languageSelect">
            <option value="vi">Tiếng Việt</option>
            <option value="en">English</option>
        </select>
    </div>
</header>
<nav id="mainNav">
    <button data-section="homeSection" data-i18n="home">
        <i class="bi bi-house-door"></i>
        <span class="nav-label">Trang chủ</span>
    </button>
    <button data-section="addMember" data-i18n="addMember">
        <i class="bi bi-person-plus"></i>
        <span class="nav-label">Thêm thành viên</span>
    </button>
    <button data-section="treeSection" data-i18n="tree">
        <i class="bi bi-diagram-3"></i>
        <span class="nav-label">Cây gia phả</span>
    </button>
    <button data-section="timelineSection" data-i18n="timeline">
        <i class="bi bi-clock-history"></i>
        <span class="nav-label">Dòng thời gian</span>
    </button>
    <button data-section="statsSection" data-i18n="stats">
        <i class="bi bi-bar-chart"></i>
        <span class="nav-label">Thống kê</span>
    </button>
    <button data-section="shareSection" data-i18n="share">
        <i class="bi bi-share"></i>
        <span class="nav-label">Chia sẻ</span>
    </button>
    <button data-section="securitySection" data-i18n="security">
        <i class="bi bi-shield-lock"></i>
        <span class="nav-label">Bảo mật</span>
    </button>
    <button data-section="toolsSection" data-i18n="tools">
        <i class="bi bi-tools"></i>
        <span class="nav-label">Công cụ</span>
    </button>
</nav>
<!-- Undo/Redo Bar -->
<div id="undoRedoBar" class="undo-redo-bar">
    <button id="undoBtn" class="icon-btn" disabled title="Undo (Ctrl+Z)">
        <i class="bi bi-arrow-counterclockwise"></i>
    </button>
    <button id="redoBtn" class="icon-btn" disabled title="Redo (Ctrl+Y)">
        <i class="bi bi-arrow-clockwise"></i>
    </button>
    <span id="actionHistory" class="action-text"></span>
</div>
<section id="homeSection" class="panel">
    <h2 data-i18n="home">Trang chủ</h2>
    <p data-i18n="welcome">Chào mừng! Bắt đầu bằng cách thêm thành viên đầu tiên.</p>
</section>
<section id="addMember" class="panel">
    <h2 data-i18n="addMember">Thêm thành viên</h2>
    <form id="memberForm" class="modern-form">
        <input type="hidden" id="memberId">

        <div class="photo-section">
            <div class="photo-preview" id="photoPreview">
                <i class="bi bi-person-circle"></i>
            </div>
            <input type="file" id="photoInput" accept="image/*" style="display:none;">
            <button type="button" id="photoBtn" class="btn-secondary" data-i18n="addPhoto">Thêm ảnh</button>
        </div>

        <div class="form-group">
            <label for="name" data-i18n="name">Họ tên</label>
            <div class="input-with-icon">
                <i class="bi bi-person"></i>
                <input type="text" id="name" required data-i18n-placeholder="namePlaceholder" placeholder="Họ tên">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="birth" data-i18n="birth">Ngày sinh</label>
                <div class="input-with-icon">
                    <i class="bi bi-calendar"></i>
                    <input type="date" id="birth">
                </div>
            </div>
            <div class="form-group">
                <label for="death" data-i18n="death">Ngày mất</label>
                <div class="input-with-icon">
                    <i class="bi bi-calendar-x"></i>
                    <input type="date" id="death">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="gender" data-i18n="gender">Giới tính</label>
                <select id="gender">
                    <option value="" data-i18n="none">--</option>
                    <option value="male" data-i18n="male">Nam</option>
                    <option value="female" data-i18n="female">Nữ</option>
                    <option value="other" data-i18n="other">Khác</option>
                </select>
            </div>
            <div class="form-group">
                <label for="occupation" data-i18n="occupation">Nghề nghiệp</label>
                <div class="input-with-icon">
                    <i class="bi bi-briefcase"></i>
                    <input type="text" id="occupation" data-i18n-placeholder="occupationPlaceholder" placeholder="Nhập nghề nghiệp">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label for="location" data-i18n="location">Nơi sinh</label>
            <div class="input-with-icon">
                <i class="bi bi-geo-alt"></i>
                <input type="text" id="location" data-i18n-placeholder="locationPlaceholder" placeholder="Nhập nơi sinh">
            </div>
        </div>

        <div class="form-group">
            <label for="notes" data-i18n="notes">Ghi chú</label>
            <textarea id="notes" rows="3" data-i18n-placeholder="notesPlaceholder" placeholder="Thêm ghi chú..."></textarea>
        </div>

        <!-- Photo Gallery (v12) -->
        <div class="form-group">
            <label data-i18n="photos">Ảnh</label>
            <div class="photo-gallery-manager">
                <div id="photoGalleryPreview" class="photo-gallery-preview"></div>
                <input type="file" id="photoGalleryInput" accept="image/*" multiple style="display:none;">
                <button type="button" id="addPhotosBtn" class="btn-secondary">
                    <i class="bi bi-images"></i> <span data-i18n="addPhotos">Thêm ảnh</span>
                </button>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="fatherSelect" data-i18n="father">Cha</label>
                <select id="fatherSelect"><option value="" data-i18n="none">--</option></select>
            </div>
            <div class="form-group">
                <label for="motherSelect" data-i18n="mother">Mẹ</label>
                <select id="motherSelect"><option value="" data-i18n="none">--</option></select>
            </div>
        </div>

        <div class="form-group">
            <label for="spouseSelect" data-i18n="spouse">Vợ/Chồng</label>
            <select id="spouseSelect"><option value="" data-i18n="none">--</option></select>
        </div>

        <div class="form-actions">
            <button type="button" id="newBtn" class="btn-secondary" data-i18n="new">
                <i class="bi bi-plus-circle"></i> Thêm mới
            </button>
            <button type="submit" class="btn-primary" data-i18n="save">
                <i class="bi bi-check-circle"></i> Lưu
            </button>
            <button type="button" id="deleteBtn" class="btn-danger" data-i18n="delete" disabled>
                <i class="bi bi-trash"></i> Xóa
            </button>
            <button type="button" id="centerBtn" class="btn-secondary" data-i18n="setCenter" disabled>
                <i class="bi bi-bullseye"></i> Chọn làm trung tâm
            </button>
        </div>
    </form>
</section>
<section id="treeSection" class="panel">
    <div class="section-header">
        <h2 data-i18n="tree">Cây gia phả</h2>
        <div class="tree-controls">
            <div class="search-box">
                <i class="bi bi-search"></i>
                <input type="text" id="searchInput" placeholder="Tìm kiếm..." data-i18n-placeholder="search">
            </div>
            <div class="zoom-controls">
                <button id="zoomOut" class="icon-btn" title="Zoom out">
                    <i class="bi bi-zoom-out"></i>
                </button>
                <span id="zoomLevel">100%</span>
                <button id="zoomIn" class="icon-btn" title="Zoom in">
                    <i class="bi bi-zoom-in"></i>
                </button>
                <button id="resetZoom" class="icon-btn" title="Reset">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>
    <div id="treeContainer" class="tree-container">
        <div id="tree" class="tree-content"></div>
    </div>
</section>
<section id="timelineSection" class="panel">
    <h2 data-i18n="timeline">Dòng thời gian</h2>
    <div class="timeline-controls">
        <button id="sortByBirth" class="active" data-i18n="sortByBirth">Theo ngày sinh</button>
        <button id="sortByAdded" data-i18n="sortByAdded">Theo thêm vào</button>
    </div>
    <div id="timeline"></div>
</section>
<section id="statsSection" class="panel">
    <h2 data-i18n="stats">Thống kê</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <i class="bi bi-people"></i>
            <div class="stat-info">
                <h3 id="totalMembers">0</h3>
                <p data-i18n="totalMembers">Tổng thành viên</p>
            </div>
        </div>
        <div class="stat-card">
            <i class="bi bi-bar-chart-steps"></i>
            <div class="stat-info">
                <h3 id="totalGenerations">0</h3>
                <p data-i18n="totalGenerations">Số thế hệ</p>
            </div>
        </div>
        <div class="stat-card">
            <i class="bi bi-cake"></i>
            <div class="stat-info">
                <h3 id="avgAge">--</h3>
                <p data-i18n="avgAge">Tuổi trung bình</p>
            </div>
        </div>
        <div class="stat-card">
            <i class="bi bi-graph-up"></i>
            <div class="stat-info">
                <h3 id="oldestMember">--</h3>
                <p data-i18n="oldestMember">Người lớn tuổi nhất</p>
            </div>
        </div>
    </div>
    <div class="charts-container">
        <div class="chart-box">
            <h3 data-i18n="generationChart">Phân bố thế hệ</h3>
            <canvas id="generationChart"></canvas>
        </div>
        <div class="chart-box">
            <h3 data-i18n="ageChart">Phân bố độ tuổi</h3>
            <canvas id="ageChart"></canvas>
        </div>
    </div>
</section>
<section id="shareSection" class="panel">
    <h2 data-i18n="share">Chia sẻ</h2>
    <div class="export-group">
        <h3 data-i18n="exportData">Xuất dữ liệu</h3>
        <button id="exportBtn" data-i18n="export">Xuất JSON</button>
        <button id="exportEncryptedBtn" data-i18n="exportEncrypted">Xuất JSON mã hóa</button>
        <button id="exportCsvBtn" data-i18n="exportCsv">Xuất CSV</button>
        <button id="backupBtn" data-i18n="backup">Sao lưu toàn bộ</button>
    </div>
    <div class="import-group">
        <h3 data-i18n="importData">Nhập dữ liệu</h3>
        <label for="importInput" class="file-label" data-i18n="chooseFile">Chọn file để nhập</label>
        <input type="file" id="importInput" accept="application/json,.csv,.backup">
        <button id="restoreBtn" data-i18n="restore">Khôi phục từ sao lưu</button>
        <input type="file" id="restoreInput" accept=".backup" style="display:none;">
    </div>
    <div class="qr-group">
        <h3 data-i18n="qrCode">Mã QR</h3>
        <button id="qrBtn" data-i18n="qr">Tạo QR Code</button>
        <div id="qrContainer"></div>
    </div>
</section>
<section id="securitySection" class="panel">
    <h2 data-i18n="security">Bảo mật</h2>
    <div class="security-info">
        <p data-i18n="securityDesc">Dữ liệu của bạn được mã hóa AES-GCM 256-bit và lưu trữ an toàn trên trình duyệt.</p>
    </div>
    <div class="password-change">
        <h3 data-i18n="changePassword">Thay đổi mật khẩu</h3>
        <form id="passwordForm">
            <label for="currentPassword" data-i18n="currentPassword">Mật khẩu hiện tại</label>
            <input type="password" id="currentPassword" required>
            <label for="newPassword" data-i18n="newPassword">Mật khẩu mới</label>
            <input type="password" id="newPassword" required>
            <label for="confirmPassword" data-i18n="confirmPassword">Xác nhận mật khẩu mới</label>
            <input type="password" id="confirmPassword" required>
            <button type="submit" data-i18n="changePasswordBtn">Đổi mật khẩu</button>
        </form>
    </div>
    <div class="data-info">
        <h3 data-i18n="dataInfo">Thông tin dữ liệu</h3>
        <div id="dataStats"></div>
        <button id="clearDataBtn" class="btn-danger" data-i18n="clearData">Xóa toàn bộ dữ liệu</button>
    </div>
</section>
<section id="toolsSection" class="panel">
    <h2 data-i18n="tools">Công cụ</h2>

    <!-- Drag & Drop Upload -->
    <div class="tool-group">
        <h3 data-i18n="dragDropUpload">Kéo thả để tải lên</h3>
        <div id="dropZone" class="drop-zone">
            <i class="bi bi-cloud-upload"></i>
            <p data-i18n="dropZoneText">Kéo file JSON/CSV/Backup vào đây hoặc click để chọn</p>
            <input type="file" id="dropZoneInput" accept=".json,.csv,.backup" style="display:none;">
        </div>
    </div>

    <!-- Birthday Reminders -->
    <div class="tool-group">
        <h3 data-i18n="birthdayReminders">Nhắc sinh nhật</h3>
        <div id="upcomingBirthdays" class="birthday-list"></div>
    </div>

    <!-- Relationship Calculator -->
    <div class="tool-group">
        <h3 data-i18n="relationshipCalc">Tính mối quan hệ</h3>
        <div class="relationship-calc">
            <div class="form-row">
                <select id="person1Select" class="form-control">
                    <option value="" data-i18n="selectPerson1">Chọn người thứ 1</option>
                </select>
                <select id="person2Select" class="form-control">
                    <option value="" data-i18n="selectPerson2">Chọn người thứ 2</option>
                </select>
            </div>
            <button id="calculateRelBtn" class="btn-primary" data-i18n="calculate">
                <i class="bi bi-calculator"></i> Tính toán
            </button>
            <div id="relationshipResult" class="relationship-result"></div>
        </div>
    </div>

    <!-- Advanced Search -->
    <div class="tool-group">
        <h3 data-i18n="advancedSearch">Tìm kiếm nâng cao</h3>
        <div class="advanced-search">
            <input type="text" id="advSearchName" placeholder="Tên..." data-i18n-placeholder="searchName">
            <div class="form-row">
                <input type="date" id="advSearchBirthFrom" placeholder="Từ ngày">
                <input type="date" id="advSearchBirthTo" placeholder="Đến ngày">
            </div>
            <select id="advSearchGeneration">
                <option value="">Tất cả thế hệ</option>
            </select>
            <button id="advSearchBtn" class="btn-primary" data-i18n="search">
                <i class="bi bi-search"></i> Tìm kiếm
            </button>
            <div id="advSearchResults" class="search-results"></div>
        </div>
    </div>

    <!-- Excel Export -->
    <div class="tool-group">
        <h3 data-i18n="excelExport">Xuất Excel</h3>
        <p data-i18n="excelDesc">Xuất dữ liệu sang file Excel (.xlsx) để dễ dàng chỉnh sửa</p>
        <button id="exportExcelBtn" class="btn-primary" data-i18n="exportExcel">
            <i class="bi bi-file-earmark-excel"></i> Xuất Excel
        </button>
    </div>

    <!-- Auto Backup Settings -->
    <div class="tool-group">
        <h3 data-i18n="autoBackup">Sao lưu tự động</h3>
        <div class="auto-backup-settings">
            <label>
                <input type="checkbox" id="enableAutoBackup">
                <span data-i18n="enableAutoBackup">Bật sao lưu tự động hàng ngày</span>
            </label>
            <p id="lastBackupTime" class="text-secondary"></p>
            <button id="backupNowBtn" class="btn-secondary" data-i18n="backupNow">
                <i class="bi bi-save"></i> Sao lưu ngay
            </button>
        </div>
    </div>
</section>
<div class="modal fade" id="actionModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="chooseAction">Chọn thao tác</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <button type="button" class="btn btn-primary w-100 mb-2" id="editBtn" data-i18n="edit">
            <i class="bi bi-pencil"></i> Sửa
        </button>
        <button type="button" class="btn btn-info w-100 mb-2" id="markAsMeBtn" data-i18n="markAsMe">
            <i class="bi bi-star"></i> Đánh dấu là tôi
        </button>
        <hr>
        <button type="button" class="btn btn-secondary w-100 mb-2" id="addChildBtn" data-i18n="addChild">
            <i class="bi bi-arrow-down"></i> Thêm con
        </button>
        <button type="button" class="btn btn-secondary w-100 mb-2" id="addSiblingBtn" data-i18n="addSibling">
            <i class="bi bi-people"></i> Thêm anh/chị/em
        </button>
        <button type="button" class="btn btn-secondary w-100 mb-2" id="addSpouseBtn" data-i18n="addSpouse">
            <i class="bi bi-heart"></i> Thêm vợ/chồng
        </button>
        <button type="button" class="btn btn-secondary w-100 mb-2" id="addFatherBtn" data-i18n="addFather">
            <i class="bi bi-arrow-up"></i> Thêm cha
        </button>
        <button type="button" class="btn btn-secondary w-100" id="addMotherBtn" data-i18n="addMother">
            <i class="bi bi-arrow-up"></i> Thêm mẹ
        </button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="childModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="childAsk">Bạn là cha hay mẹ của người con?</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <button
            type="button"
            class="btn btn-primary w-100 mb-2"
            id="childAsFatherBtn"
            data-i18n="asFather">Tôi là cha</button>
        <button
            type="button"
            class="btn btn-secondary w-100"
            id="childAsMotherBtn"
            data-i18n="asMother">Tôi là mẹ</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container"></div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay">
    <div class="spinner"></div>
</div>

<!-- Keyboard Shortcuts Modal -->
<div class="modal fade" id="shortcutsModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" data-i18n="keyboardShortcuts">Phím tắt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="shortcuts-list">
          <div class="shortcut-item">
            <kbd>Ctrl</kbd> + <kbd>N</kbd>
            <span data-i18n="newMember">Thêm thành viên mới</span>
          </div>
          <div class="shortcut-item">
            <kbd>Ctrl</kbd> + <kbd>S</kbd>
            <span data-i18n="saveMember">Lưu thành viên</span>
          </div>
          <div class="shortcut-item">
            <kbd>Ctrl</kbd> + <kbd>F</kbd>
            <span data-i18n="searchFocus">Tìm kiếm</span>
          </div>
          <div class="shortcut-item">
            <kbd>Ctrl</kbd> + <kbd>E</kbd>
            <span data-i18n="exportData">Xuất dữ liệu</span>
          </div>
          <div class="shortcut-item">
            <kbd>Ctrl</kbd> + <kbd>D</kbd>
            <span data-i18n="toggleDarkMode">Bật/tắt chế độ tối</span>
          </div>
          <div class="shortcut-item">
            <kbd>?</kbd>
            <span data-i18n="showShortcuts">Hiển thị phím tắt</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="lib/qrcode.min.js"></script>
<script src="script.js"></script>
</body>
</html>

